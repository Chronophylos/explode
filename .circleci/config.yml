version: 2.1
orbs: 
  rust: circleci/rust@1.6.0
node: &node
  working_directory: ~/project
  docker:
  - image: cimg/node:current
  resource_class: medium
default: &default
  working_directory: ~/project
  docker:
  - image: cimg/rust:1.61
default_medium: &default_medium
  working_directory: ~/project
  docker:
  - image: cimg/rust:1.61
  resource_class: medium

commands:
  restore_node_module_cache:
    steps:
    - restore_cache:
        name: Restoring node_module cache
        key: package-lock-v1-{{ checksum "package-lock.json" }}
  save_node_module_cache:
    steps:
    - save_cache:
        name: Saving node_module cache
        key: package-lock-v1-{{ checksum "package-lock.json" }}
        paths:
        - ~/.npm
  restore_rustup_cache:
    steps:
    - restore_cache:
        name: Restoring rustup cache
        key: rust-v1-{{ checksum "rust-toolchain.toml" }}
  save_rustup_cache:
    steps:
    - save_cache:
        name: Saving rustup cache
        key: rust-v1-{{ checksum "rust-toolchain.toml" }}
        paths:
        - ~/.rustup
  restore_cargo_cache:
    steps:
    - restore_cache:
        name: Restoring cargo cache
        key: cargo-lock-v2-{{ checksum "Cargo.lock" }}
  save_cargo_cache:
    steps:
    - save_cache:
        name: Saving cargo cache
        key: cargo-lock-v2-{{ checksum "Cargo.lock" }}
        paths:
          - ~/.cargo

jobs:
  setup:
    <<: *node
    steps:
    - checkout
    - restore_node_module_cache
    - run:
        name: Install dependencies
        command: npm install
    - save_node_module_cache
    - persist_to_workspace:
        root: ~/project
        paths:
        - node_modules

  install_rust:
    <<: *default_medium
    steps:
    - checkout
    - restore_rustup_cache
    - run:
        name: Show rustup home
        command: rustup show home
    - run:
        name: Show and install selected toolchain
        command: rustup show
    - save_rustup_cache
    - restore_cargo_cache
    - run:
        name: Download dependencies
        command: cargo fetch
    - run:
        name: Install tools
        command: cargo install cargo-nextest cargo-pants
    - save_cargo_cache


  lint_commit_message:
    <<: *node
    steps:
    - checkout
    - attach_workspace:
        at: ~/project
    - run:
        name: Define environment variable with lastest commit's message
        command: |
          echo 'export COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s")' >> $BASH_ENV
          source $BASH_ENV
    - run:
        name: Lint commit message
        command: echo "$COMMIT_MESSAGE" | npx commitlint
    
  test:
    <<: *default
    steps:
    - checkout
    - run:
        name: Install circleci-junit-fix
        command: |
          mkdir -p ~/.local/bin
          curl -sSL https://github.com/conradludgate/circleci-junit-fix/releases/download/v0.1.0/circleci-junit-fix-v0.1.0-x86_64-unknown-linux-gnu.tar.gz | tar -xz --directory=$HOME/.local/bin
    - restore_cargo_cache
    - restore_rustup_cache
    - run:
        name: Run tests
        command: cargo nextest run --profile ci --color always
    - run:
        name: Preprocess JUnit file
        command: cat target/nextest/ci/junit.xml | circleci-junit-fix > fixed-report.xml
    - store_test_results:
        path: fixed-report.xml
    
  format:
    <<: *default_medium
    steps:
    - checkout
    - restore_cargo_cache
    - restore_rustup_cache
    - run:
        name: Run rustfmt
        command: cargo --color always fmt -- --check
    - save_cargo_cache
    
  clippy:
    <<: *default
    steps:
    - checkout
    - restore_cargo_cache
    - restore_rustup_cache
    - run:
        name: Run Clippy
        command: cargo --color always clippy
    
  build:
    <<: *default
    steps:
    - checkout
    - restore_cargo_cache
    - restore_rustup_cache
    - run:
        name: Build binary
        command: cargo --color always build --release
  
  pants:
    <<: *default_medium
    steps:
    - checkout
    - restore_cargo_cache
    - restore_rustup_cache
    - run:
        name: Run cargo pants
        command: cargo pants --louds
  

workflows:
  version: 2
  commit:
    jobs:
    - setup
    - install_rust
    - lint_commit_message: { requires: [setup] }
    - test: { requires: [install_rust] }
    - format: { requires: [install_rust] }
    - clippy: { requires: [install_rust] }
    - build: { requires: [install_rust] }
  
